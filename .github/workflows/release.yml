name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          $PSVersionTable
      
      - name: Extract version from tag
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          Write-Host "Tag: $tag"
          echo "VERSION=$tag" >> $env:GITHUB_ENV
      
      - name: Create Release Notes
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}"
          
          # ä» git tag æ¶ˆæ¯ä¸­æå–å‘å¸ƒè¯´æ˜
          $tagMessage = git tag -l -n999 $version | Select-Object -Skip 1 | Out-String
          
          # åˆ›å»º release notes æ–‡ä»¶
          $releaseNotes = @"
          # FCL+Musa $version
          
          $tagMessage
          
          ## ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          ### äºŒè¿›åˆ¶åŒ…ï¼ˆå³å°†æä¾›ï¼‰
          - **FCLMusa-$version-R0-Driver.zip**: å†…æ ¸é©±åŠ¨ (R0)
          - **FCLMusa-$version-R3-Libs.zip**: ç”¨æˆ·æ€åº“ (R3)
          - **FCLMusa-$version-Samples.zip**: ç¤ºä¾‹ç¨‹åº
          
          ### æºç 
          - **Source code (zip)**: å®Œæ•´æºç åŒ…
          - **Source code (tar.gz)**: å®Œæ•´æºç åŒ…
          
          ## ğŸ“ å¿«é€Ÿå¼€å§‹
          
          ### æ„å»ºç¯å¢ƒè¦æ±‚
          - Visual Studio 2022
          - Windows Driver Kit (WDK) 10.0.22621.0+
          - .NET SDK 6.0+ æˆ– NuGet CLI
          - PowerShell 7.0+
          
          ### é¦–æ¬¡æ„å»º
          
          1. å…‹éš†ä»“åº“å¹¶åˆå§‹åŒ–å­æ¨¡å—ï¼š
          ``````powershell
          git clone https://github.com/lusipad/FCLMua.git
          cd FCLMua
          git submodule update --init --recursive
          ``````
          
          2. è¯Šæ–­æ„å»ºç¯å¢ƒï¼š
          ``````powershell
          pwsh tools/scripts/diagnose_build_issues.ps1
          ``````
          
          3. è¿è¡Œäº¤äº’å¼æ„å»ºï¼š
          ``````powershell
          pwsh build.ps1
          ``````
          
          ### é‡åˆ°é—®é¢˜ï¼Ÿ
          
          è¿è¡Œè¯Šæ–­å·¥å…·è·å–è¯¦ç»†ä¿¡æ¯ï¼š
          ``````powershell
          pwsh tools/scripts/diagnose_build_issues.ps1
          ``````
          
          æŸ¥çœ‹æ–‡æ¡£ï¼š
          - [BUILD_SYSTEM.md](https://github.com/lusipad/FCLMua/blob/main/BUILD_SYSTEM.md)
          - [CONTRIBUTING.md](https://github.com/lusipad/FCLMua/blob/main/CONTRIBUTING.md)
          
          æäº¤ Issueï¼šhttps://github.com/lusipad/FCLMua/issues
          "@
          
          $releaseNotes | Out-File -FilePath release_notes.md -Encoding UTF8
          
          Write-Host "Release notes created:"
          Get-Content release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
